<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFme Template Designer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin-bottom: 5px;
        }
        .header p {
            opacity: 0.8;
            font-size: 14px;
        }
        .controls {
            background-color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
        }
        .controls button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background-color: #2980b9;
        }
        .controls button.success {
            background-color: #27ae60;
        }
        .controls button.success:hover {
            background-color: #229954;
        }
        .controls button.danger {
            background-color: #e74c3c;
        }
        .controls button.danger:hover {
            background-color: #c0392b;
        }
        #designer-container {
            width: 100%;
            height: calc(100vh - 180px);
        }
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #27ae60;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .message.error {
            background-color: #e74c3c;
        }
        .template-list {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .template-list select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÑ PDFme Template Designer</h1>
        <p>Design your PDF templates visually and save them to your templates directory</p>
    </div>

    <div class="controls">
        <div class="template-list">
            <label>Load Template:</label>
            <select id="template-select">
                <option value="">-- Select Template --</option>
            </select>
            <button onclick="loadSelectedTemplate()">Load</button>
        </div>

        <div style="flex: 1;"></div>

        <input type="text" id="template-name" placeholder="Enter template name (e.g., my_template)">
        <button class="success" onclick="saveTemplate()">üíæ Save Template</button>
        <button onclick="downloadJSON()">‚¨áÔ∏è Download JSON</button>
        <button class="danger" onclick="resetDesigner()">üîÑ Reset</button>
    </div>

    <div id="designer-container"></div>
    <div id="message" class="message"></div>

    <script src="https://cdn.jsdelivr.net/npm/@pdfme/common@4.0.0/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdfme/schemas@4.0.0/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdfme/ui@4.0.0/dist/index.js"></script>

    <script>
        const { Designer } = pdfmeUI;
        const { text, image, barcodes } = pdfmeSchemas;

        let designer;

        // Default blank template
        const defaultTemplate = {
            basePdf: {
                width: 210,
                height: 297,
                padding: [10, 10, 10, 10]
            },
            schemas: [{}]
        };

        // Initialize designer
        async function initDesigner(template = defaultTemplate) {
            const container = document.getElementById('designer-container');
            container.innerHTML = '';

            designer = new Designer({
                domContainer: container,
                template: template,
                plugins: {
                    text,
                    image,
                    qrcode: barcodes.qrcode,
                }
            });
        }

        // Load templates list
        async function loadTemplatesList() {
            try {
                const response = await fetch('/api/templates');
                const templates = await response.json();

                const select = document.getElementById('template-select');
                select.innerHTML = '<option value="">-- Select Template --</option>';

                templates.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage('Failed to load templates list', true);
            }
        }

        // Load selected template
        async function loadSelectedTemplate() {
            const select = document.getElementById('template-select');
            const templateName = select.value;

            if (!templateName) {
                showMessage('Please select a template', true);
                return;
            }

            try {
                const response = await fetch(`/api/templates/${templateName}`);
                if (!response.ok) throw new Error('Template not found');

                const template = await response.json();
                await initDesigner(template);

                document.getElementById('template-name').value = templateName;
                showMessage(`Template "${templateName}" loaded successfully`);
            } catch (error) {
                showMessage(`Failed to load template: ${error.message}`, true);
            }
        }

        // Save template to server
        async function saveTemplate() {
            const templateName = document.getElementById('template-name').value.trim();

            if (!templateName) {
                showMessage('Please enter a template name', true);
                return;
            }

            // Remove .json extension if user added it
            const cleanName = templateName.replace(/\.json$/, '');

            try {
                const template = designer.getTemplate();

                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: cleanName,
                        template: template
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save template');
                }

                showMessage(`Template "${cleanName}" saved successfully! ‚úÖ`);
                loadTemplatesList(); // Refresh the list
            } catch (error) {
                showMessage(`Failed to save template: ${error.message}`, true);
            }
        }

        // Download template as JSON
        function downloadJSON() {
            const templateName = document.getElementById('template-name').value.trim() || 'template';
            const template = designer.getTemplate();

            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${templateName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('Template downloaded!');
        }

        // Reset designer
        async function resetDesigner() {
            if (confirm('Reset the designer? This will clear all your work.')) {
                await initDesigner();
                document.getElementById('template-name').value = '';
                showMessage('Designer reset');
            }
        }

        // Show message
        function showMessage(text, isError = false) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = isError ? 'message error' : 'message';
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await initDesigner();
            await loadTemplatesList();
        });
    </script>
</body>
</html>
